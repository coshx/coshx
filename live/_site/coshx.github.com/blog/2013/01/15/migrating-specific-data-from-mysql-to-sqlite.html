<p>A strategy for migrating specific data (such as all active users) from mysql to a sqlite using Ruby drivers and ActiveRecord.</p>

<ol>
<li>Create/Commandeer a rails app.</li>
<li>Install mysql 2.8.1, ruby-mysql and sqlite3</li>
<li>Create ActiveRecord schema from existing mysql database by pointing rails config/database.yml to the mysql database and using rake db:schema:dump</li>
<li>Remove :force => true from the newly generated schema.rb to prevent accidentally destroying the mysql database data</li>
<li>Migrate database structure defined in ActiveRecord schema to new sqlite database by changing config/database.yml to point to a new sqlite database and running rake db:schema:load.</li>
<li>Using ruby drivers, select records from mysql database according to the specific parameters and insert the results into the new sqlite database. In the example script below, data is transferred only for active users (users with 'active' field set to true).</li>
</ol>


<hr />

<p>```ruby</p>

<h1>schema.rb</h1>

<p>ActiveRecord::Schema.define(:version => 0) do
  create_table "users" do |t|</p>

<pre><code>t.integer "photo_id"
t.boolean "active"
</code></pre>

<p>  end
  create_table "posts"  do |t|</p>

<pre><code>t.integer "user_id"
</code></pre>

<p>  end
  create_table "photos" do |t|
  end
end</p>

<p>```</p>

<p>```ruby</p>

<h1>script.rb</h1>

<p>require 'mysql'
require 'sqlite3'</p>

<h1>transfer_table('users', 'id', active_user_ids)</h1>

<h1>transfer_table('posts', 'user_id', active_user_ids)</h1>

<h1>transfer_table('photos', 'id', active_user_photo_ids)</h1>

<p>def transfer_table(table_name, id_column_name, ids_to_transfer)
  ids_to_transfer.each do |id|</p>

<pre><code>mysql_records = mysql_select(table_name, id_column_name, id)
mysql_records.each do |record|
  sqlite_insert(table_name, record)
end
</code></pre>

<p>  end
end</p>

<p>def active_user_ids
  @active_user_ids ||= mysql_result_to_array(</p>

<pre><code>mysql.query(
  "SELECT id FROM users
   WHERE active = true ;"
)
</code></pre>

<p>  ).collect { |record| record.first }
end</p>

<p>def active_user_photo_ids
  @active_user_ids ||= mysql_result_to_array(</p>

<pre><code>mysql.query(
  "SELECT id FROM photos
   WHERE user_id IN (#{active_user_ids});"
)
</code></pre>

<p>  ).collect { |record| record.first }
end</p>

<p>def mysql_result_to_array(mysql_result)
   array = Array.new
   mysql_result.each{|row| array.push(row)}
   return array
end</p>

<p>def mysql_select(table_name, id_column_name, id)
  mysql_columns = mysql_columns(table_name)
  mysql_result_to_array(</p>

<pre><code>mysql.query(
  "SELECT #{mysql_columns}
   FROM #{table_name}
   WHERE #{id_column_name} = #{id}"
)
</code></pre>

<p>  )
end</p>

<p>def sqlite_insert(table_name,mysql_record)
  sqlite_columns =  sqlite_columns(table_name)
  sqlite_values = sqlite_values(mysql_record)
  sqlite.execute(</p>

<pre><code>"INSERT INTO #{table_name} (#{sqlite_columns})
 VALUES (#{sqlite_values});"
</code></pre>

<p>  )
end</p>

<p>def mysql_columns(table_name)
  columns(table_name).collect{ |column|</p>

<pre><code>"#{table_name}.#{column.first}"
</code></pre>

<p>  }.join ','
end</p>

<p>def sqlite_columns(table_name)
  columns(table_name).collect { |column|</p>

<pre><code>"[#{column.first}]"
</code></pre>

<p>  }.join ','
end</p>

<p>def columns(table_name)
  mysql_result_to_array(</p>

<pre><code>mysql.query(
  "show columns from #{table_name} ;"
)
</code></pre>

<p>  )
end</p>

<p>def sqlite_values(mysql_record)
  mysql_record.to_s.gsub(/<sup>[/,</sup> "").chop
  .gsub('nil', "\"\"").gsub("\\"", "'")
end</p>

<p>def sqlite
  @sqlite ||= SQLite3::Database.new('db.sqlite')
end</p>

<p>def mysql
  @mysql ||= Mysql.connect('localhost', 'user', 'password', 'database')
end</p>

<p>transfer_table('users', 'id', active_user_ids)
transfer_table('posts', 'user_id', active_user_ids)
transfer_table('photos', 'id', active_user_photo_ids)</p>
